use svg_exploit_checker::svg_checker::{SvgChecker, SvgCheckError, Config};
use tempfile;

#[tokio::test]
async fn test_script_tag_detection() {
    let svg_content = r#"
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <script>alert('XSS');</script>
    </svg>"#;

    let temp_dir = tempfile::tempdir().unwrap();
    let file_path = temp_dir.path().join("test.svg");
    std::fs::write(&file_path, svg_content).unwrap();

    let config = Config::default();
    let checker = SvgChecker::new(config);
    let result = checker.check_file(file_path).await;

    assert!(matches!(result, Err(SvgCheckError::ExploitDetected(msg)) if msg.contains("Script tag found")));
}

#[tokio::test]
async fn test_safe_svg() {
    let svg_content = r#"
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <rect width="100" height="100" fill="blue" />
    </svg>"#;

    let temp_dir = tempfile::tempdir().unwrap();
    let file_path = temp_dir.path().join("safe.svg");
    std::fs::write(&file_path, svg_content).unwrap();

    let config = Config::default();
    let checker = SvgChecker::new(config);
    let result = checker.check_file(file_path).await;

    assert!(result.is_ok());
}

#[tokio::test]
async fn test_image_tag_external_resource() {
    let svg_content = r#"
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <image href="https://example.com/image.png" />
    </svg>"#;

    let result = run_test_for_tag(svg_content).await;
    println!("Image tag test result: {:?}", result);
    assert!(matches!(result, Err(SvgCheckError::ExploitDetected(msg)) if msg.contains("External resource found in tag image")));
}

#[tokio::test]
async fn test_use_tag_external_resource() {
    let svg_content = r#"
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <use href="https://example.com/sprite.svg#icon" />
    </svg>"#;

    let result = run_test_for_tag(svg_content).await;
    println!("Use tag test result: {:?}", result);
    assert!(matches!(result, Err(SvgCheckError::ExploitDetected(msg)) if msg.contains("External resource found in tag use")));
}

#[tokio::test]
async fn test_script_tag_external_resource() {
    let svg_content = r#"
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <script href="https://example.com/script.js" />
    </svg>"#;

    let result = run_test_for_tag(svg_content).await;
    println!("Script tag test result: {:?}", result);
    assert!(matches!(result, Err(SvgCheckError::ExploitDetected(msg)) if msg.contains("External resource found in tag script")));
}

#[tokio::test]
async fn test_link_tag_external_resource() {
    let svg_content = r#"
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <link href="https://example.com/styles.css" rel="stylesheet" />
    </svg>"#;

    let result = run_test_for_tag(svg_content).await;
    println!("Link tag test result: {:?}", result);
    assert!(matches!(result, Err(SvgCheckError::ExploitDetected(msg)) if msg.contains("External resource found in tag link")));
}

#[tokio::test]
async fn test_foreign_object() {
    let svg_content = r#"
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <foreignObject x="10" y="10" width="80" height="80">
            <div xmlns="http://www.w3.org/1999/xhtml">Some HTML content</div>
        </foreignObject>
    </svg>"#;

    let result = run_test_for_tag(svg_content).await;
    println!("Foreign object test result: {:?}", result);
    assert!(matches!(result, Err(SvgCheckError::ExploitDetected(msg)) if msg.contains("foreignObject tag found")));
}

#[tokio::test]
async fn test_css_injection() {
    let svg_content = r#"
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <rect width="100" height="100" style="fill: url('https://evil.com/exploit.svg')" />
        <style>
            body { background: url('https://test-h8sh3d.com/bg.jpg'); }
        </style>
    </svg>"#;

    let result = run_test_for_tag(svg_content).await;
    println!("CSS injection test result: {:?}", result);
    assert!(matches!(result, Err(SvgCheckError::ExploitDetected(msg)) if msg.contains("Potential CSS injection found")));
}

#[tokio::test]
async fn test_dangerous_animation_suspicious_value() {
    let svg_content = r#"
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <rect width="100" height="100">
            <animate attributeName="x" from="0" to="javascript:alert('XSS')" dur="5s" />
        </rect>
    </svg>"#;

    let result = run_test_for_tag(svg_content).await;
    assert!(matches!(result, Err(SvgCheckError::ExploitDetected(msg)) if msg.contains("Suspicious value 'javascript:alert('XSS')' found in 'to' attribute")));
}

#[tokio::test]
async fn test_multiple_rules() {
    let svg_content = r#"
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <image href="https://example.com/image.png" />
        <animate attributeName="href" from="\#safe" to="\#danger" dur="5s" />
    </svg>"#;

    let result = run_test_for_tag(svg_content).await;
    eprintln!("Multiple rules test result: {:?}", result);
    assert!(matches!(result, Err(SvgCheckError::ExploitDetected(msg)) if 
        msg.contains("External resource found") || msg.contains("Dangerous animation targeting 'href' found")));
}

#[tokio::test]
async fn test_base64_embedding() {
    let svg_content = r#"
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <image href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" />
    </svg>"#;

    let result = run_test_for_tag(svg_content).await;
    println!("Base64 embedding test result: {:?}", result);
    assert!(matches!(result, Err(SvgCheckError::ExploitDetected(msg)) if msg.contains("Base64 encoded data found")));
}

#[tokio::test]
async fn test_malicious_link() {
    let svg_content = r#"
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <a href="http://example.com/javascript:alert('XSS')">Malicious Link</a>
    </svg>"#;

    let result = run_test_for_tag(svg_content).await;
    println!("Malicious link test result: {:?}", result);
    assert!(matches!(result, Err(SvgCheckError::ExploitDetected(msg)) if msg.contains("Potentially malicious link detected")));
}

#[tokio::test]
async fn test_id_reuse() {
    let svg_content = r#"
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <rect id="shape1" width="50" height="50" fill="blue" />
        <circle id="shape1" cx="75" cy="75" r="25" fill="red" />
    </svg>"#;

    let result = run_test_for_tag(svg_content).await;
    println!("ID reuse test result: {:?}", result);
    assert!(matches!(result, Err(SvgCheckError::ExploitDetected(msg)) if msg.contains("Duplicate ID found: shape1")));
}

async fn run_test_for_tag(svg_content: &str) -> Result<(), SvgCheckError> {
    let temp_dir = tempfile::tempdir().unwrap();
    let file_path = temp_dir.path().join("test.svg");
    std::fs::write(&file_path, svg_content).unwrap();

    let config = Config {
        rules: vec![
            "ScriptTagRule".to_string(),
            "ExternalResourceRule".to_string(),
            "InlineEventHandlerRule".to_string(),
            "ForeignObjectRule".to_string(),
            "CssInjectionRule".to_string(),
            "DangerousAnimationRule".to_string(),
            "Base64EmbeddingRule".to_string(),
            "MaliciousLinkRule".to_string(),
            "IdReuseRule".to_string(),
        ],
    };
    let checker = SvgChecker::new(config);
    checker.check_file(file_path).await
}